var app=angular.module('picpay',['ngSanitize','ngMask']);app.config(['$httpProvider','$interpolateProvider',function($httpProvider,$interpolateProvider){$httpProvider.defaults.timeout=5000;$interpolateProvider.startSymbol('<%');$interpolateProvider.endSymbol('%>')}]);app.controller('UserCtrl',function($scope,$window,$http,$timeout){$scope.form={};$scope.users=[];$scope.flags=[{id:1,icon:'public/assets/elo.png',name:'Elo'},{id:2,icon:'public/assets/visa.png',name:'Visa'},{id:3,icon:'public/assets/mastercard.png',name:'MasterCard'},{id:4,icon:'public/assets/americanexpress.png',name:'American Express'}];$scope.modal=0;$scope.index=0;$scope.listCards=JSON.parse(localStorage.getItem("cards"));$scope.listCards=$scope.listCards==null?[]:$scope.listCards;$scope.listCardsBkp=[];$scope.cardSelected={number:null,checked:true,expiry_date:null,code:null,cep:null,name:null,flag:null};$scope.flagSelected={id:0,icon:'',name:'Selecione a bandeira'};$scope.cardsUpdate=false;$scope.lastModal=0;$scope.innerWidth=$window.innerWidth;$scope.getUsers=function(){var request={method:'get',url:'http://careers.picpay.com/tests/mobdev/users',dataType:'json',contentType:"application/json"};$http(request).then(function(data){$scope.users=data.data})};$scope.setFlag=function(index){$scope.flagSelected=$scope.flags[index];$scope.form.flag=$scope.flags[index]};$scope.backHome=function(){$scope.modal=0};$scope.closeModal=function(){if($scope.lastModal==3){angular.copy($scope.listCardsBkp,$scope.listCards);$scope.lastModal=0;$scope.openModal($scope.index)}else if($scope.lastModal==4){$scope.lastModal=0;$scope.modal=4}else{$scope.modal=0}$scope.cardsUpdate=false;if($scope.listCardsBkp.length>0){angular.copy($scope.listCardsBkp,$scope.listCards)}};$scope.selectCard=function(){$scope.lastModal=$scope.modal;$scope.modal=4};$scope.setCardDefault=function(index){$scope.cardsUpdate=true;angular.copy($scope.listCards,$scope.listCardsBkp);for(i=0;i<$scope.listCards.length;i++){$scope.listCards[i].checked=false;if(i==index){$scope.listCards[i].checked=true}}};$scope.saveCardDefault=function(){localStorage.setItem("cards",JSON.stringify($scope.listCards));$scope.cardsUpdate=false;angular.copy($scope.listCards,$scope.listCardsBkp)};$scope.saveCard=function(){$scope.lastModal=$scope.modal;var check=true;if($scope.listCards.length>0){check=false}if(!$scope.form.number){return}var obj={number:$scope.form.number,checked:check,expiry_date:$scope.form.expiry_date,code:$scope.form.cvv,cep:$scope.form.cep,name:$scope.form.name,flag:$scope.form.flag};$scope.listCards.push(obj);localStorage.setItem("cards",JSON.stringify($scope.listCards));$scope.modal=4};$scope.openModal=function(index){$scope.modal=1;$scope.index=index;$scope.cardSelected={};var cards=0;cards=$scope.listCards.length;for(i=0;i<$scope.listCards.length;i++){if($scope.listCards[i].checked){$scope.cardSelected=$scope.listCards[i];break}}if(cards>0){$scope.modal=3}else{$scope.modal=1}};$scope.registerCard=function(){$scope.form={};$scope.lastModal=$scope.modal;$scope.modal=2;$scope.cardsUpdate=false;if($scope.listCardsBkp.length>0){angular.copy($scope.listCardsBkp,$scope.listCards)}};$scope.payment=function(){var request={method:'post',url:'http://careers.picpay.com/tests/mobdev/transaction',data:{"card_number":$scope.cardSelected.number.replace(new RegExp(' ','g'),''),"cvv":$scope.cardSelected.cvv,"value":$scope.form.value,"expiry_date":$scope.cardSelected.expiry_date.substr(0,3)+$scope.cardSelected.expiry_date.substr(5,2),"destination_user_id":$scope.users[$scope.index].id}};$http(request).then(function(data){if(data.data.transaction.status=='Aprovada'){$scope.form.value=null;$scope.lastModal=0;$scope.modal=5;$scope.transaction=data.data.transaction}else{$scope.toastColor='#ef5778';$scope.toastMessage='Seu pagamento foi recusado.'}$timeout(function(){$scope.toastMessage=''},3000)})};$scope.getUsers();$(window).resize(function(){$scope.$apply(function(){$scope.innerWidth=$window.innerWidth;var tmp=$scope.modal;$scope.modal=-1;$scope.modal=tmp})})});