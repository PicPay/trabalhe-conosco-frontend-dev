"use strict";var isDefined=angular.isDefined,isUndefined=angular.isUndefined,isNumber=angular.isNumber,isObject=angular.isObject,isArray=angular.isArray,isString=angular.isString,extend=angular.extend,toJson=angular.toJson;angular.module("LocalStorageModule",[]).provider("localStorageService",function(){this.prefix="ls",this.storageType="localStorage",this.cookie={expiry:30,path:"/",secure:!1},this.defaultToCookie=!0,this.notify={setItem:!0,removeItem:!1},this.setPrefix=function(e){return this.prefix=e,this},this.setStorageType=function(e){return this.storageType=e,this},this.setDefaultToCookie=function(e){return this.defaultToCookie=!!e,this},this.setStorageCookie=function(e,t,o){return this.cookie.expiry=e,this.cookie.path=t,this.cookie.secure=o,this},this.setStorageCookieDomain=function(e){return this.cookie.domain=e,this},this.setNotify=function(e,t){return this.notify={setItem:e,removeItem:t},this},this.$get=["$rootScope","$window","$document","$parse","$timeout",function(e,t,o,r,n){function i(o){if(o||(o=t.event),l.setItem&&isString(o.key)&&h(o.key)){var r=d(o.key);n(function(){e.$broadcast("LocalStorageModule.notification.changed",{key:r,newvalue:o.newValue,storageType:s.storageType})})}}var a,s=this,c=s.prefix,u=s.cookie,l=s.notify,f=s.storageType;o?o[0]&&(o=o[0]):o=document,"."!==c.substr(-1)&&(c=c?c+".":"");var g=function(e){return c+e},d=function(e){return e.replace(new RegExp("^"+c,"g"),"")},h=function(e){return 0===e.indexOf(c)},y=function(){try{var o=f in t&&null!==t[f],r=g("__"+Math.round(1e7*Math.random()));return o&&(a=t[f],a.setItem(r,""),a.removeItem(r)),o}catch(t){return s.defaultToCookie&&(f="cookie"),e.$broadcast("LocalStorageModule.notification.error",t.message),!1}},m=y(),T=function(t,o,r){var n=x();try{if(M(r),o=isUndefined(o)?null:toJson(o),!m&&s.defaultToCookie||"cookie"===s.storageType)return m||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),l.setItem&&e.$broadcast("LocalStorageModule.notification.setitem",{key:t,newvalue:o,storageType:"cookie"}),O(t,o);try{a&&a.setItem(g(t),o),l.setItem&&e.$broadcast("LocalStorageModule.notification.setitem",{key:t,newvalue:o,storageType:s.storageType})}catch(r){return e.$broadcast("LocalStorageModule.notification.error",r.message),O(t,o)}return!0}finally{M(n)}},v=function(t,o){var r=x();try{if(M(o),!m&&s.defaultToCookie||"cookie"===s.storageType)return m||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),L(t);var n=a?a.getItem(g(t)):null;if(!n||"null"===n)return null;try{return JSON.parse(n)}catch(e){return n}}finally{M(r)}},p=function(){var t=x();try{var o=0;arguments.length>=1&&("localStorage"===arguments[arguments.length-1]||"sessionStorage"===arguments[arguments.length-1])&&(o=1,M(arguments[arguments.length-1]));var r,n;for(r=0;r<arguments.length-o;r++)if(n=arguments[r],!m&&s.defaultToCookie||"cookie"===s.storageType)m||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),l.removeItem&&e.$broadcast("LocalStorageModule.notification.removeitem",{key:n,storageType:"cookie"}),$(n);else try{a.removeItem(g(n)),l.removeItem&&e.$broadcast("LocalStorageModule.notification.removeitem",{key:n,storageType:s.storageType})}catch(t){e.$broadcast("LocalStorageModule.notification.error",t.message),$(n)}}finally{M(t)}},S=function(t){var o=x();try{if(M(t),!m)return e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),[];var r=c.length,n=[];for(var i in a)if(i.substr(0,r)===c)try{n.push(i.substr(r))}catch(t){return e.$broadcast("LocalStorageModule.notification.error",t.Description),[]}return n}finally{M(o)}},k=function(t,o){var r=x();try{M(o);var n=c?new RegExp("^"+c):new RegExp,i=t?new RegExp(t):new RegExp;if(!m&&s.defaultToCookie||"cookie"===s.storageType)return m||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),E();if(!m&&!s.defaultToCookie)return!1;var u=c.length;for(var l in a)if(n.test(l)&&i.test(l.substr(u)))try{p(l.substr(u))}catch(t){return e.$broadcast("LocalStorageModule.notification.error",t.message),E()}return!0}finally{M(r)}},b=function(){try{return t.navigator.cookieEnabled||"cookie"in o&&(o.cookie.length>0||(o.cookie="test").indexOf.call(o.cookie,"test")>-1)}catch(t){return e.$broadcast("LocalStorageModule.notification.error",t.message),!1}}(),O=function(t,r,n,i){if(isUndefined(r))return!1;if((isArray(r)||isObject(r))&&(r=toJson(r)),!b)return e.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;try{var a="",s=new Date,c="";if(null===r?(s.setTime(s.getTime()+-864e5),a="; expires="+s.toGMTString(),r=""):isNumber(n)&&0!==n?(s.setTime(s.getTime()+24*n*60*60*1e3),a="; expires="+s.toGMTString()):0!==u.expiry&&(s.setTime(s.getTime()+24*u.expiry*60*60*1e3),a="; expires="+s.toGMTString()),t){var l="; path="+u.path;u.domain&&(c="; domain="+u.domain),"boolean"==typeof i?!0===i&&(c+="; secure"):!0===u.secure&&(c+="; secure"),o.cookie=g(t)+"="+encodeURIComponent(r)+a+l+c}}catch(t){return e.$broadcast("LocalStorageModule.notification.error",t.message),!1}return!0},L=function(t){if(!b)return e.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;for(var r=o.cookie&&o.cookie.split(";")||[],n=0;n<r.length;n++){for(var i=r[n];" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(g(t)+"=")){var a=decodeURIComponent(i.substring(c.length+t.length+1,i.length));try{var s=JSON.parse(a);return"number"==typeof s?a:s}catch(e){return a}}}return null},$=function(e){O(e,null)},E=function(){for(var e=null,t=c.length,r=o.cookie.split(";"),n=0;n<r.length;n++){for(e=r[n];" "===e.charAt(0);)e=e.substring(1,e.length);var i=e.substring(t,e.indexOf("="));$(i)}},x=function(){return f},M=function(e){return e&&f!==e&&(f=e,m=y()),m},C=function(e,t,o,n,i){n=n||t;var a=v(n,i);return null===a&&isDefined(o)?a=o:isObject(a)&&isObject(o)&&(a=extend(a,o)),r(t).assign(e,a),e.$watch(t,function(e){T(n,e,i)},isObject(e[t]))};m&&(t.addEventListener?(t.addEventListener("storage",i,!1),e.$on("$destroy",function(){t.removeEventListener("storage",i)})):t.attachEvent&&(t.attachEvent("onstorage",i),e.$on("$destroy",function(){t.detachEvent("onstorage",i)})));var _=function(e){var o=x();try{M(e);for(var r=0,n=t[f],i=0;i<n.length;i++)0===n.key(i).indexOf(c)&&r++;return r}finally{M(o)}};return{isSupported:m,getStorageType:x,setStorageType:M,setPrefix:function(e){c=e},set:T,add:T,get:v,keys:S,remove:p,clearAll:k,bind:C,deriveKey:g,underiveKey:d,length:_,defaultToCookie:this.defaultToCookie,cookie:{isSupported:b,set:O,add:O,get:L,remove:$,clearAll:E}}}]});